<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="keywords" content="Hexo Theme Redefine"><meta name="author" content="Brathon"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://evan.beee.top" crossorigin><link rel="preconnect" href="https://unpkg.com" crossorigin><link rel="canonical" href="https://fiddling.blog/2023/06/12/红队的夜行衣——反反制的那些事/"><meta name="robots" content="index,follow"><meta name="googlebot" content="index,follow"><meta name="revisit-after" content="1 days"><meta name="description" content="false"><meta property="og:type" content="article"><meta property="og:title" content="红队的夜行衣——反反制的那些事"><meta property="og:url" content="https://fiddling.blog/2023/06/12/%E7%BA%A2%E9%98%9F%E7%9A%84%E5%A4%9C%E8%A1%8C%E8%A1%A3%E2%80%94%E2%80%94%E5%8F%8D%E5%8F%8D%E5%88%B6%E7%9A%84%E9%82%A3%E4%BA%9B%E4%BA%8B/index.html"><meta property="og:site_name" content="Brathon&#39;s Blog"><meta property="og:description" content="false"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://github.com/BrathonBai/ImgHS/raw/main/content/anonymous/Pasted-image-20230608145739.1fjkjpneb77k.png"><meta property="og:image" content="https://github.com/BrathonBai/ImgHS/raw/main/content/anonymous/Pasted-image-20230608151944.4au5uej22hk0.png"><meta property="og:image" content="https://github.com/BrathonBai/ImgHS/raw/main/content/anonymous/Pasted-image-20230608153324.75gq8evsrd80.png"><meta property="og:image" content="https://github.com/BrathonBai/ImgHS/raw/main/content/anonymous/Pasted-image-20230608161458.46xcx17x4o80.png"><meta property="og:image" content="https://github.com/BrathonBai/ImgHS/raw/main/content/anonymous/Pasted-image-20230612180542.1860haoz2q1s.png"><meta property="og:image" content="https://github.com/BrathonBai/ImgHS/raw/main/content/anonymous/Pasted-image-20230612191411.4pyo23tedpc0.png"><meta property="og:image" content="https://github.com/BrathonBai/ImgHS/raw/main/content/anonymous/Pasted-image-20230612192152.3kucz59u5iw0.png"><meta property="og:image" content="https://github.com/BrathonBai/ImgHS/raw/main/content/anonymous/Pasted-image-20230612192951.5h98nsy4xks0.png"><meta property="og:image" content="https://github.com/BrathonBai/ImgHS/raw/main/content/anonymous/Pasted-image-20230612193221.3wf994r3qvy0.png"><meta property="og:image" content="https://github.com/BrathonBai/ImgHS/raw/main/content/anonymous/Pasted-image-20230612193411.10pazdrlztxs.png"><meta property="og:image" content="https://github.com/BrathonBai/ImgHS/raw/main/content/anonymous/Pasted-image-20230612201324.5gs0c61u0280.webp"><meta property="og:image" content="https://github.com/BrathonBai/ImgHS/raw/main/content/anonymous/Pasted-image-20230612205751.30odvevfqvi0.webp"><meta property="og:image" content="https://github.com/BrathonBai/ImgHS/raw/main/content/anonymous/Pasted-image-20230612215035.6r5d92tsx640.webp"><meta property="og:image" content="https://github.com/BrathonBai/ImgHS/raw/main/content/anonymous/Pasted-image-20230612215209.nkhbabb287k.webp"><meta property="article:published_time" content="2023-06-12T14:42:22.000Z"><meta property="article:modified_time" content="2023-06-12T15:23:15.000Z"><meta property="article:author" content="Brathon"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://github.com/BrathonBai/ImgHS/raw/main/content/anonymous/Pasted-image-20230608145739.1fjkjpneb77k.png"><link rel="icon" type="image/png" href="https://cdn.staticaly.com/gh/BrathonBai/ImgHS@main/brthton icon.png" sizes="192x192"><link rel="apple-touch-icon" sizes="180x180" href="https://cdn.staticaly.com/gh/BrathonBai/ImgHS@main/brthton icon.png"><meta name="theme-color" content="#A31F34"><link rel="shortcut icon" href="https://cdn.staticaly.com/gh/BrathonBai/ImgHS@main/brthton icon.png"><title>红队的夜行衣——反反制的那些事 - Brathon&#39;s Blog</title><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="https://unpkg.com/hexo-theme-redefine@2.1.2/source/assets/fonts.css"><script data-pjax async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9466387333958601" crossorigin="anonymous"></script><script id="hexo-configurations">let Global=window.Global||{};Global.hexo_config={hostname:"fiddling.blog",root:"/",language:"zh-CN",path:"search.xml"},Global.theme_config={articles:{style:{font_size:"16px",line_height:1.5,image_border_radius:"14px",image_alignment:"center",image_caption:!0,link_icon:!0},word_count:{enable:!0,count:!0,min2read:!0},author_label:{enable:!0,auto:!1,list:[""]},code_block:{copy:!0,style:"mac",font:{enable:!1,family:null,url:null}},toc:{enable:!0,max_depth:5,number:!1,expand:!0,init_open:!0},copyright:!0,lazyload:!0,recommendation:{enable:!0,title:"推荐阅读",limit:3,placeholder:"/images/wallhaven-wqery6-light.webp",skip_dirs:[]}},colors:{primary:"#A31F34",secondary:null},global:{fonts:{chinese:{enable:!1,family:null,url:null},english:{enable:!1,family:null,url:null}},content_max_width:"1000px",sidebar_width:"210px",hover:{shadow:!0,scale:!1},scroll_progress:{bar:!1,percentage:!0},busuanzi_counter:{enable:!0,site_pv:!0,site_uv:!0,post_pv:!0},pjax:!0,open_graph:!0},home_banner:{enable:!0,image:{light:"/images/wallhaven-wqery6-light.webp",dark:"/images/wallhaven-wqery6-dark.webp"},title:"Brathon's Blog",subtitle:{text:["Fiddling科技工作室","没事瞎捣鼓协会荣誉成员","Welcome and Enjoy!"],hitokoto:{enable:!1,api:"https://v1.hitokoto.cn"},typing_speed:100,backing_speed:80,starting_delay:500,backing_delay:1500,loop:!0,smart_backspace:!0},text_color:{light:"#fff",dark:"#d1d1b6"},text_style:{title_size:"2.8rem",subtitle_size:"1.5rem",line_height:1.2},custom_font:{enable:!1,family:null,url:null},social_links:{enable:!1,links:{github:null,instagram:null,zhihu:null,twitter:null,email:null}}},plugins:{feed:{enable:!1},aplayer:{enable:!1,type:"fixed",audios:[{name:null,artist:null,url:null,cover:null}]},mermaid:{enable:!1,version:"9.3.0"},all_minifier:!0},version:"2.1.2",navbar:{auto_hide:!0,color:{left:"#f78736",right:"#367df7",transparency:45},links:{Home:{path:"/",icon:"fa-regular fa-house"},Archives:{path:"/archives",icon:"fa-regular fa-archive"},Friends:{path:"/links/",icon:"fa-solid fa-link"},Tags:{path:"/tags/",icon:"fa-solid fa-tags"},"资源":{icon:"fa-solid fa-books",submenus:{"工具箱":{path:"/tools/",icon:"fa-regular fa-hammer"},"电影":{path:"/films/",icon:"fa-solid fa-films"},"音乐":{path:"/musics/",icon:"fa-solid fa-music"},"书籍":{path:"/books/",icon:"fa-regular fa-book-open"}}}},search:{enable:!0,preload:!0}},page_templates:{friends_column:2,tags_style:"cloud"},home:{sidebar:{enable:!0,position:"left",first_item:"menu",announcement:"达瓦里氏，革命尚未结束，信念不能动摇。",links:null},article_date_format:"auto",categories:{enable:!0,limit:3},tags:{enable:!0,limit:3}}},Global.language_ago={second:"%s 秒前",minute:"%s 分钟前",hour:"%s 小时前",day:"%s 天前",week:"%s 周前",month:"%s 个月前",year:"%s 年前"}</script><link rel="stylesheet" href="https://unpkg.com/hexo-theme-redefine@2.1.2/source/fontawesome/fontawesome.min.css"><link rel="stylesheet" href="https://unpkg.com/hexo-theme-redefine@2.1.2/source/fontawesome/brands.min.css"><link rel="stylesheet" href="https://unpkg.com/hexo-theme-redefine@2.1.2/source/fontawesome/solid.min.css"><link rel="stylesheet" href="https://unpkg.com/hexo-theme-redefine@2.1.2/source/fontawesome/regular.min.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div class="progress-bar-container"><span class="pjax-progress-bar"></span> <span class="pjax-progress-icon"><i class="fa-solid fa-circle-notch fa-spin"></i></span></div><main class="page-container"><div class="main-content-container"><div class="main-content-header"><header class="navbar-container"><div class="navbar-content"><div class="left"><a class="logo-image" href="/"><img src="https://cdn.staticaly.com/gh/BrathonBai/ImgHS@main/brthton%20icon.png"> </a><a class="logo-title" href="/">Brathon&#39;s Blog</a></div><div class="right"><div class="desktop"><ul class="navbar-list"><li class="navbar-item"><a href="/"><i class="fa-regular fa-house"></i> 首页</a></li><li class="navbar-item"><a href="/archives"><i class="fa-regular fa-archive"></i> 归档</a></li><li class="navbar-item"><a href="/links/"><i class="fa-solid fa-link"></i> 友情链接</a></li><li class="navbar-item"><a href="/tags/"><i class="fa-solid fa-tags"></i> 标签</a></li><li class="navbar-item"><a class="has-dropdown" href="#" onclick="return!1"><i class="fa-solid fa-books"></i> 资源&nbsp;<i class="fa-solid fa-chevron-down"></i></a><ul class="sub-menu"><li><a href="/%5Bobject%20Object%5D">工具箱</a></li><li><a href="/%5Bobject%20Object%5D">电影</a></li><li><a href="/%5Bobject%20Object%5D">音乐</a></li><li><a href="/%5Bobject%20Object%5D">书籍</a></li></ul></li><li class="navbar-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i></li></ul></div><div class="mobile"><div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i></div><div class="icon-item navbar-bar"><div class="navbar-bar-middle"></div></div></div></div></div><div class="navbar-drawer"><ul class="drawer-navbar-list"><li class="drawer-navbar-item flex-center"><a href="/"><i class="fa-regular fa-house"></i> 首页</a></li><li class="drawer-navbar-item flex-center"><a href="/archives"><i class="fa-regular fa-archive"></i> 归档</a></li><li class="drawer-navbar-item flex-center"><a href="/links/"><i class="fa-solid fa-link"></i> 友情链接</a></li><li class="drawer-navbar-item flex-center"><a href="/tags/"><i class="fa-solid fa-tags"></i> 标签</a></li><li class="drawer-navbar-item flex-center"><a class="has-dropdown" href="#" onclick="return!1"><i class="fa-solid fa-books"></i> 资源&nbsp;<i class="fa-solid fa-chevron-down"></i></a></li><li class="dropdown-item flex-center"><a class="dropdown-item" href="/%5Bobject%20Object%5D">工具箱</a></li><li class="dropdown-item flex-center"><a class="dropdown-item" href="/%5Bobject%20Object%5D">电影</a></li><li class="dropdown-item flex-center"><a class="dropdown-item" href="/%5Bobject%20Object%5D">音乐</a></li><li class="dropdown-item flex-center"><a class="dropdown-item" href="/%5Bobject%20Object%5D">书籍</a></li></ul></div><div class="window-mask"></div></header></div><div class="main-content-body"><div class="main-content"><div class="fade-in-down-animation"><div class="post-page-container"><div class="article-content-container"><div class="article-title"><img src="https://cdn.staticaly.com/gh/BrathonBai/ImgHS@main/cover/miku/82867352_p1.70g8sf8hv2s0.webp" alt="红队的夜行衣——反反制的那些事"><h1 class="article-title-cover">红队的夜行衣——反反制的那些事</h1></div><div class="article-header"><div class="avatar"><img src="https://cdn.staticaly.com/gh/BrathonBai/ImgHS@main/brthton%20icon.png"></div><div class="info"><div class="author"><span class="name">Brathon</span> <span class="author-label"></span></div><div class="meta-info"><div class="article-meta-info"><span class="article-date article-meta-item"><i class="fa-regular fa-pen-fancy"></i>&nbsp; <span class="desktop">2023-06-12 22:42:22</span> <span class="mobile">2023-06-12 22:42</span> <span class="hover-info">创建</span> </span><span class="article-date article-meta-item"><i class="fa-regular fa-wrench"></i>&nbsp; <span class="desktop">2023-06-12 23:23:15</span> <span class="mobile">2023-06-12 23:23</span> <span class="hover-info">更新</span> </span><span class="article-wordcount article-meta-item"><i class="fa-regular fa-typewriter"></i>&nbsp;<span>3.1k 字</span> </span><span class="article-min2read article-meta-item"><i class="fa-regular fa-clock"></i>&nbsp;<span>11 分钟</span> </span><span class="article-pv article-meta-item"><i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span></span></div></div></div></div><div class="article-content markdown-body"><blockquote><p>有同志问了，那我就献丑了。</p></blockquote><h2 id="蓝队在防什么"><a href="#蓝队在防什么" class="headerlink" title="蓝队在防什么"></a>蓝队在防什么</h2><p>作为多年参与蓝队的点鼠标猴子，我简单讲讲猴子平常干点啥。<br>先不涉及蓝队的前期布防，直接讲攻防进行时。</p><ul><li>监控：通过安全设备，发现异常流量，定位发起者ip和url，将相关流量情况上报给研判。<br></li><li>研判：在第一天的时候也会做点监控的活，将发现的异常流量进行分析，确认流量中的行为是否是红方攻击流量，需要与甲方的技术人员进行沟通确认。如果发现流量中存在红方身份特征，同时会要求溯源人员进行及时响应。<br></li><li>指挥：背锅的<br>通常甲方不会外聘“指挥”，当然，如果指挥也是甲方外聘的，那么乙方能放进甲方的岗位通常就这三种，至于溯源嘛，那是乙方原厂自己的人，想参与溯源的临时参与者就别想了。<br>综上，蓝队会从安全设备中发现并提取带有 *攻击特征* 的流量信息，同时会从蜜罐中寻找同样特征的信息，并确认红方身份，进行溯源，同时IP封禁。</li></ul><h2 id="打铁还需自身硬"><a href="#打铁还需自身硬" class="headerlink" title="打铁还需自身硬"></a>打铁还需自身硬</h2><p>作为红队，除了需要有足够强悍的<em>外网打点</em>、<em>漏洞挖掘</em> 、<em>内网渗透</em>这些实力外，还需要在反溯源、反定位、反暴露、流量特征隐藏等手段中磨练，以下是笔者意识到的部分问题。</p><h3 id="WebRTC——真实IP暴露的罪魁祸首"><a href="#WebRTC——真实IP暴露的罪魁祸首" class="headerlink" title="WebRTC——真实IP暴露的罪魁祸首"></a>WebRTC——真实IP暴露的罪魁祸首</h3><p>说起这件事，还要从今年微博博主：安全北北的一篇微博说起<br></p><figure class="image-caption"><img lazyload src="/images/loading.svg" data-src="https://github.com/BrathonBai/ImgHS/raw/main/content/anonymous/Pasted-image-20230608145739.1fjkjpneb77k.png" alt="Pasted-image-20230608145739"><figcaption>Pasted-image-20230608145739</figcaption></figure><br>获取ip的网站：<br><a class="link" target="_blank" rel="noopener" href="https://www.hackjie.com/tracking">https://www.hackjie.com/tracking <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a><br><a class="link" target="_blank" rel="noopener" href="https://ip8.com/webrtc-test">https://ip8.com/webrtc-test <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a><br>打开网站后我们发现自己的ip直接就在网站上显示出来了，这事谁看谁崩溃 ，于是就有了这样一个疑问：为什么即使平常有挂代理的习惯，还是会暴露外网ip呢？<p></p><blockquote><ul><li><strong>什么是WebRTC？</strong><br>网络实时通信（WebRTC）是一项先进的开源技术，允许台式机和移动浏览器通过使用简单的API实时交换数据。<br>WebRTC有大量的用途，包括通过移动或基于网络的应用实现音频、视频和网络功能。WebRTC的功能类似于媒体捕获和流媒体API。所有这三种功能可以结合起来，实现网络上前所未有的惊人的多媒体功能。<br>WebRTC的关键优势在于它能实现实时的点对点多媒体通信，这在当今的数字媒体时代是不可缺少的。</li><li><strong>关键组成部分</strong><br>WebRTC包括3个主要的API：<br>- 同行连接：这允许你发送和接收多媒体文件<br>- GetUserMedia：顾名思义，它可以访问用户的媒体（如摄像头和麦克风）。<br>- 数据通道：允许在浏览器之间直接传输非媒体。</li></ul></blockquote><pre><code>    WebRTC目前在以下浏览器上得到支持：Mozilla Firefox, Opera, Chrome和Google Chrome。
</code></pre><blockquote><ul><li><strong>反面</strong><br>WebTRC的一个主要缺点是，由于用户使用的VPN泄露了他们的IP地址，用户的隐私可能会受到影响。<br>由Paolo Stagno在2015年发现并标记为 “WebTRC泄漏”，当一些知名的VPN供应商开始在未经用户同意的情况下将用户的IP地址泄露给网站时，一些用户的隐私被泄露了。<br>更糟糕的是，最近的一项调查指出，有23%的VPN供应商正在泄露用户的IP地址，并保留了设备类型、个人信息、访问过的网站，甚至是支付信息等个人信息。</li></ul></blockquote><p>简单来说就是，WebRTC这个技术，直接将你的浏览器和服务端建立联系，绕过了中间所有的代理。</p><p>我们打开B站搜索WebRTC，会看到，这个技术经常应用于视频通话、点对点通信等等。<br></p><figure class="image-caption"><img lazyload src="/images/loading.svg" data-src="https://github.com/BrathonBai/ImgHS/raw/main/content/anonymous/Pasted-image-20230608151944.4au5uej22hk0.png" alt="Pasted-image-20230608151944"><figcaption>Pasted-image-20230608151944</figcaption></figure><p></p><blockquote><ul><li><strong>防范策略</strong></li></ul></blockquote><ol><li>直接从浏览器扩展入手：<br>下载并安装Chrome&#x2F;Edge&#x2F;Firefox浏览器扩展：WebRTC Leak Shield<div class="highlight-container" data-rel="Http"><figure class="iseeu highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">https://chrome.google.com/webstore/detail/webrtc-leak-shield/bppamachkoflopbagkdoflbgfjflfnfl  </span><br><span class="line"></span><br><span class="line">https://microsoftedge.microsoft.com/addons/detail/pblfgfehcokbglafpcldgjpmknildihk  </span><br><span class="line"></span><br><span class="line">https://addons.mozilla.org/en-US/firefox/addon/webrtc-leak-shield/</span><br></pre></td></tr></table></figure></div></li><li>从浏览器本身配置入手：<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chrome://flags/#enable-webrtc-hide-local-ips-with-mdns  </span><br><span class="line">opera://flags/#enable-webrtc-hide-local-ips-with-mdns  </span><br><span class="line">edge://flags/#enable-webrtc-hide-local-ips-with-mdns</span><br></pre></td></tr></table></figure></div>但经过测试，还是扩展好用<br>Firefox配置项：<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">about:config  </span><br><span class="line">media.peerconnection.enabled</span><br></pre></td></tr></table></figure></div>FireFox不需要扩展，直接配置就比上面那些搞扩展的好使。</li></ol><blockquote><ul><li><strong>再测试</strong>：</li></ul></blockquote><figure class="image-caption"><img lazyload src="/images/loading.svg" data-src="https://github.com/BrathonBai/ImgHS/raw/main/content/anonymous/Pasted-image-20230608153324.75gq8evsrd80.png" alt="Pasted-image-20230608153324"><figcaption>Pasted-image-20230608153324</figcaption></figure><h2 id="代理池"><a href="#代理池" class="headerlink" title="代理池"></a>代理池</h2><p>作为一个红队成员，在打点过程中，最讨厌的就是信息还在收集，扫描器还在运行时，突然就拿不到数据了，不用问，被封ip了。<br>但信息收集和找口子阶段少不了大批量的扫描流量的发送了，这就需要红队自身要有足够多的ip喂给蓝队去封禁。<br>介绍几个代理池项目：<br><a class="link" target="_blank" rel="noopener" href="https://github.com/jhao104/proxy_pool">https://github.com/jhao104/proxy_pool <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a><br><a class="link" target="_blank" rel="noopener" href="https://github.com/Anyyy111/ProxyPoolxSocks">https://github.com/Anyyy111/ProxyPoolxSocks <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a><br>代理池的原理和代理服务器一样，没啥好讲的，只不过用于爬虫的代理服务器会快速更换代理ip，直到ip池中的ip都被封禁。<br></p><figure class="image-caption"><img lazyload src="/images/loading.svg" data-src="https://github.com/BrathonBai/ImgHS/raw/main/content/anonymous/Pasted-image-20230608161458.46xcx17x4o80.png" alt="Pasted-image-20230608161458"><figcaption>Pasted-image-20230608161458</figcaption></figure><br>啥？你问我ip从哪来？买的，找ip提供商买的，和你科学上网买梯子是一回事。<p></p><hr><p>以上都是简单可操作的部分，接下来就要上强度了</p><hr><h2 id="云函数"><a href="#云函数" class="headerlink" title="云函数"></a>云函数</h2><blockquote><p>总结这一块知识的时候，感觉这一块内容太丰富，甚至应该单独开一篇来写</p></blockquote><h4 id="什么是云函数"><a href="#什么是云函数" class="headerlink" title="什么是云函数"></a>什么是云函数</h4><pre><code>云函数提供了一种直接在云上运行，无状态的、短暂的、由事件触发的代码的能力。
对比：
随着云服务的发展，计算资源高度抽象化，腾讯云提供了从物理服务器到云函数和横跨各种抽象程度的计算资源供用户选择。
黑石物理服务器：以物理机为扩展单位。用户完全拥有整台实体计算资源，安全性最好。
云服务器：以云服务器为扩展单位，虚拟化硬件设备。用户和其他租户共享物理机资源，仍可自行配置 CVM 的各项指标，相对部署和迭代更加简单。
容器服务：以服务为扩展单位，虚拟化操作系统。测试和生产环境完全一致，测试和部署非常轻松。
云函数：以函数为扩展单位，虚拟化运行时环境（Runtime）。是现有计算资源的最小单位，具有完全自动、一键部署、高度可扩展等特点，是轻量级服务部署非常好的选择。
【引自腾讯云文档】
</code></pre><figure class="image-caption"><img lazyload src="/images/loading.svg" data-src="https://github.com/BrathonBai/ImgHS/raw/main/content/anonymous/Pasted-image-20230612180542.1860haoz2q1s.png" alt="Pasted-image-20230612180542"><figcaption>Pasted-image-20230612180542</figcaption></figure><p><strong>特性：</strong></p><ol><li>云函数不需要服务器，也就是说你不需要去买 VPS。<br></li><li>云函数只是云厂商用自己的服务器帮你运行你上传的代码片段， 执行某个单一的逻辑，可以简单理解为只帮你执行一个函数。<br></li><li>云函数无法长驻，调用的时候创建，执行完之后立即就销毁，所以无法直接保存状态。也正是这一点，让我们无法代理像 SSH 这种需要长连接的服务，只能代理 HTTP(s) 这种无状态的协议。<br></li></ol><p>利用云厂商提供的云函数（函数计算）功能，将客户端的HTTP请求进行转发，由于云函数多出口的特性，让我们也变相拥有了代理池。</p><p>当前国内已知云平台，阿里云和腾讯云都可以使用云函数。</p><h4 id="怎么使用云函数"><a href="#怎么使用云函数" class="headerlink" title="怎么使用云函数"></a>怎么使用云函数</h4><p>目标：将burp、CS、webshell等攻击流量全部通过云函数代理，以达到不可封禁和不可溯源的效果。</p><p>设计：<br></p><figure class="image-caption"><img lazyload src="/images/loading.svg" data-src="https://github.com/BrathonBai/ImgHS/raw/main/content/anonymous/Pasted-image-20230612191411.4pyo23tedpc0.png" alt="Pasted-image-20230612191411"><figcaption>Pasted-image-20230612191411</figcaption></figure><br>如图，浏览器访问流量经过本地代理程序，转发到云服务端，经由写好的云函数将我们发出的流量进行重新打包，并由云服务的DNS再次发送至目标站点。<br>从目标站点来看，我们发送的流量，都是由云服务商提供的ip进行的访问。<br>更有趣的是，无论是微步qax的威胁情报平台都会记录来自云服务商的干净ip。<p></p><p>于是我们根据场景，可以制作【基于云函数的socks代理】和【基于云函数的http代理】</p><p>以腾讯云为例<br></p><figure class="image-caption"><img lazyload src="/images/loading.svg" data-src="https://github.com/BrathonBai/ImgHS/raw/main/content/anonymous/Pasted-image-20230612192152.3kucz59u5iw0.png" alt="Pasted-image-20230612192152"><figcaption>Pasted-image-20230612192152</figcaption></figure><br>在腾讯云控制台，找到函数服务，新建云函数<br><figure class="image-caption"><img lazyload src="/images/loading.svg" data-src="https://github.com/BrathonBai/ImgHS/raw/main/content/anonymous/Pasted-image-20230612192951.5h98nsy4xks0.png" alt="Pasted-image-20230612192951"><figcaption>Pasted-image-20230612192951</figcaption></figure><br>云函数可以使用多种语言编写，当前已知的项目都是python写的<br>建议牛逼的大佬都用go来写<br><figure class="image-caption"><img lazyload src="/images/loading.svg" data-src="https://github.com/BrathonBai/ImgHS/raw/main/content/anonymous/Pasted-image-20230612193221.3wf994r3qvy0.png" alt="Pasted-image-20230612193221"><figcaption>Pasted-image-20230612193221</figcaption></figure><br>之后配置timeout的时间，900秒，足够大佬在被封前拿到想要的数据了。<br><figure class="image-caption"><img lazyload src="/images/loading.svg" data-src="https://github.com/BrathonBai/ImgHS/raw/main/content/anonymous/Pasted-image-20230612193411.10pazdrlztxs.png" alt="Pasted-image-20230612193411"><figcaption>Pasted-image-20230612193411</figcaption></figure><br>设置API触发<br>以上就是腾讯云的云函数实现socks代理的办法<p></p><p>http这一块相比，就是多了个鉴权，去B站还能找到添加了ssl证书的https版本。</p><p>可以看一下渣渣老师在2021年发布的腾讯云云函数代理办法:</p><p><a class="link" target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1x64y1873g/?share_source=copy_web&vd_source=c5b1bc1a031a95bca5007f137fe846b8">https://www.bilibili.com/video/BV1x64y1873g/?share_source=copy_web&amp;vd_source=c5b1bc1a031a95bca5007f137fe846b8 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p><p>也可也看看大C老师做的基于阿里云云函数代理办法，这个是用go写的:</p><p><a class="link" target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1ML4y1M7Cu/?share_source=copy_web&vd_source=c5b1bc1a031a95bca5007f137fe846b8">https://www.bilibili.com/video/BV1ML4y1M7Cu/?share_source=copy_web&amp;vd_source=c5b1bc1a031a95bca5007f137fe846b8 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p><p>啥？不会写？行吧，有位大佬在Github上发布了一键部署项目:<br><a class="link" target="_blank" rel="noopener" href="https://github.com/shimmeris/SCFProxy/blob/main/README_zh.md">https://github.com/shimmeris/SCFProxy/blob/main/README_zh.md <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a><br>还看不懂就真的帮不了你了。</p><h2 id="利用硬件隐身"><a href="#利用硬件隐身" class="headerlink" title="利用硬件隐身"></a>利用硬件隐身</h2><p>这一块就没什么难的，我一句话概括：<strong>用手机开热点</strong></p><p>我就知道你会骂我</p><ul><li><p>手机开热点为什么好使吗？</p><p>前面WebRTC中讲到，如果你使用宽带上网，服务器会获取你的公网ip，而公网ip都是由运营商提供的，除非你很有钱，买了一个独享的ip专线，否则，你就是和整个小区，甚至整个街区共用同一个ip。因此，ip定位不会太详细。</p></li></ul><p>比如，笔者所在的这个小县城共用一个ip。。。（手动狗头）</p><ul><li><p>问题又来了，手机开热点，也是运营商提供的上网服务啊，怎么就找不到呢？</p><p>已知手机上网的办法并不是宽带的那一套，而是WCDMA的那一套东西，使用的ip是由基站分配的，也不会太详细。</p></li></ul><p>但即使不详细，这个定位依然很好使啊，至少它定位到了搞事情所在的城市甚至小区啊。<br><br><br>这里就用到了一个不起眼的小玩具：<br></p><figure class="image-caption"><img lazyload src="/images/loading.svg" data-src="https://github.com/BrathonBai/ImgHS/raw/main/content/anonymous/Pasted-image-20230612201324.5gs0c61u0280.webp" alt="Pasted-image-20230612201324"><figcaption>Pasted-image-20230612201324</figcaption></figure><p></p><p>没错就是 <strong>随身WIFI</strong></p><p>还是手机开热点的那一套</p><p>但可以实现匿名的点在 <strong>流量卡</strong> 上，笔者曾经记录使用流量卡上网时的ip<br>每次ip定位都在不同的城市，从来就没有过ip定位在所在地附近的情况。<br>于是，渗透机流量经过随身WIFI转发，再经由14层协议到达目标，目标机上记录的ip就是和你丝毫没关系的运营商基站ip。</p><p>但这就完事了吗？这也太没劲了</p><p>如图，笔者把随身WIFI拆了，并深入进去逆了一下。</p><p>硬件：CPU4核｜ROM512MB｜RAM4GB</p><p>架构：ARM v7 Processor rev0（v7l）</p><p>自带系统：Android4.4</p><p>熟不熟悉？就是手机！</p><p>红米2的配置！</p><p>虽然性能不大，但是刷进去一个arm的linux系统不是刚刚好嘛？<br>于是我刷了个OpenWrt</p><p>然后连进去看看<br></p><figure class="image-caption"><img lazyload src="/images/loading.svg" data-src="https://github.com/BrathonBai/ImgHS/raw/main/content/anonymous/Pasted-image-20230612205751.30odvevfqvi0.webp" alt="Pasted-image-20230612205751"><figcaption>Pasted-image-20230612205751</figcaption></figure><br>ok这就是个linux机子！<p></p><figure class="image-caption"><img lazyload src="/images/loading.svg" data-src="https://github.com/BrathonBai/ImgHS/raw/main/content/anonymous/Pasted-image-20230612215035.6r5d92tsx640.webp" alt="Pasted-image-20230612215035"><figcaption>Pasted-image-20230612215035</figcaption></figure><figure class="image-caption"><img lazyload src="/images/loading.svg" data-src="https://github.com/BrathonBai/ImgHS/raw/main/content/anonymous/Pasted-image-20230612215209.nkhbabb287k.webp" alt="Pasted-image-20230612215209"><figcaption>Pasted-image-20230612215209</figcaption></figure><p>同时还可以安装Debian，Debian这一块我还没试<br>但是我们大胆推测<br>linux都有了，ssh上去，一顿nmap &amp;&amp; subfinder | httpx | nuclei<br>那可太爽了<br>甚至，写进去自动化渗透脚本，再把棒子找个信号好、有电源的地方一放<br>近源渗透的事也解决了有没有？</p><p>说回主题，既然这个随身WIFI棒子就是一个linux机子，那么我们把代理池云函数等同时集成到棒子上，我们就直接实现了随身软路由。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本篇文章我们从多种角度实现了红队的自我隐匿，而且付出代价不多。还方便逃跑。</p><hr><blockquote><p>参考：<br><a class="link" target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/A5dd7WXojGBzsz52_iLtJQ">https://mp.weixin.qq.com/s/A5dd7WXojGBzsz52_iLtJQ <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a><br><a class="link" target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1857034">https://cloud.tencent.com/developer/article/1857034 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a><br><a class="link" target="_blank" rel="noopener" href="https://cloud.tencent.com/document/product/583/9694">https://cloud.tencent.com/document/product/583/9694 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a><br><a class="link" target="_blank" rel="noopener" href="https://www.cnblogs.com/supdon/p/15099742.html">https://www.cnblogs.com/supdon/p/15099742.html <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a><br><a class="link" target="_blank" rel="noopener" href="https://github.com/shimmeris/SCFProxy/blob/main/README_zh.md">https://github.com/shimmeris/SCFProxy/blob/main/README_zh.md <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a><br><a class="link" target="_blank" rel="noopener" href="https://qust.me/post/m[sm8916](https://acg.tv/sm8916)/">https://qust.me/post/m[sm8916](https://acg.tv/sm8916)/ <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p></blockquote></div><div class="post-copyright-info"><div class="article-copyright-info-container"><ul><li><strong>标题:</strong> 红队的夜行衣——反反制的那些事</li><li><strong>作者:</strong> Brathon</li><li><strong>创建于:</strong> 2023-06-12 22:42:22</li><li><strong>更新于:</strong> 2023-06-12 23:23:15</li><li><strong>链接:</strong> https://fiddling.blog/2023/06/12/红队的夜行衣——反反制的那些事/</li><li><strong>版权声明:</strong> 本文章采用 <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">CC BY-NC-SA 4.0</a> 进行许可。</li></ul></div></div><div class="recommended-article"><div class="recommended-article-header"><i aria-hidden="true"></i><span>推荐阅读</span></div><div class="recommended-article-group"><a class="recommended-article-item" href="/2023/04/23/Android刷机流程/" title="Android刷机流程" rel="bookmark"><img src="https://cdn.staticaly.com/gh/BrathonBai/ImgHS@main/cover/miku/76784594_p0.4gnoz1oba1i0.webp" alt="Android刷机流程"> <span class="title">Android刷机流程</span> </a><a class="recommended-article-item" href="/2023/04/23/关于社会工程学的一些个人看法/" title="关于社会工程学的一些个人看法" rel="bookmark"><img src="https://cdn.staticaly.com/gh/BrathonBai/ImgHS@main/cover/miku/102734382_p0.1vu0sy0v7kao.webp" alt="关于社会工程学的一些个人看法"> <span class="title">关于社会工程学的一些个人看法</span> </a><a class="recommended-article-item" href="/2023/07/19/不过是SSRF-为什么面试官老问这个？/" title="不过是SSRF 为什么面试官老问这个？" rel="bookmark"><img src="https://cdn.staticaly.com/gh/BrathonBai/ImgHS@main/cover/miku/85411065_p0.50x7opso60o0.webp" alt="不过是SSRF 为什么面试官老问这个？"> <span class="title">不过是SSRF 为什么面试官老问这个？</span></a></div></div><div class="article-nav"><div class="article-prev"><a class="prev" rel="prev" href="/2023/07/19/%E4%B8%8D%E8%BF%87%E6%98%AFSSRF-%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9D%A2%E8%AF%95%E5%AE%98%E8%80%81%E9%97%AE%E8%BF%99%E4%B8%AA%EF%BC%9F/"><span class="left arrow-icon flex-center"><i class="fa-solid fa-chevron-left"></i> </span><span class="title flex-center"><span class="post-nav-title-item">不过是SSRF 为什么面试官老问这个？</span> <span class="post-nav-item">上一篇</span></span></a></div><div class="article-next"><a class="next" rel="next" href="/2023/04/23/ipa%E4%BB%8E%E8%8E%B7%E5%8F%96%E5%88%B0%E7%A0%B8%E5%A3%B3/"><span class="title flex-center"><span class="post-nav-title-item">ipa从获取到砸壳</span> <span class="post-nav-item">下一篇</span> </span><span class="right arrow-icon flex-center"><i class="fa-solid fa-chevron-right"></i></span></a></div></div><div class="comment-container"><div class="comments-container"><div id="comment-anchor"></div><div class="comment-area-title"><i class="fa-solid fa-comments"></i>&nbsp;评论</div><div id="waline"></div><script type="module" data-pjax>import{init}from"https://evan.beee.top/js/waline.mjs";function loadWaline(){init({el:"#waline",serverURL:"https://waline-eight-mu.vercel.app/",lang:"zh-CN",dark:'body[class~="dark-mode"]',requiredMeta:["nick","mail"]})}{const e=setTimeout(()=>{loadWaline(),clearTimeout(e)},1e3)}</script></div></div></div><div class="toc-content-container"><div class="post-toc-wrap"><div class="post-toc"><div class="toc-title">此页目录</div><div class="page-title">红队的夜行衣——反反制的那些事</div><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%93%9D%E9%98%9F%E5%9C%A8%E9%98%B2%E4%BB%80%E4%B9%88"><span class="nav-text">蓝队在防什么</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%93%E9%93%81%E8%BF%98%E9%9C%80%E8%87%AA%E8%BA%AB%E7%A1%AC"><span class="nav-text">打铁还需自身硬</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#WebRTC%E2%80%94%E2%80%94%E7%9C%9F%E5%AE%9EIP%E6%9A%B4%E9%9C%B2%E7%9A%84%E7%BD%AA%E9%AD%81%E7%A5%B8%E9%A6%96"><span class="nav-text">WebRTC——真实IP暴露的罪魁祸首</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%A3%E7%90%86%E6%B1%A0"><span class="nav-text">代理池</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%91%E5%87%BD%E6%95%B0"><span class="nav-text">云函数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E4%BA%91%E5%87%BD%E6%95%B0"><span class="nav-text">什么是云函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%80%8E%E4%B9%88%E4%BD%BF%E7%94%A8%E4%BA%91%E5%87%BD%E6%95%B0"><span class="nav-text">怎么使用云函数</span></a></li></ol></li></ol><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E7%A1%AC%E4%BB%B6%E9%9A%90%E8%BA%AB"><span class="nav-text">利用硬件隐身</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-text">总结</span></a></li></div></div></div></div></div></div></div><div class="main-content-footer"><footer class="footer"><div class="info-container"><div class="copyright-info">&copy; <span>2021</span> - 2023&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration:0.5s;color:#f54545"></i>&nbsp;&nbsp;<a href="/">Brathon</a></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="website-count info-item"><span id="busuanzi_container_site_uv" class="busuanzi_container_site_uv">访问人数&nbsp;<span id="busuanzi_value_site_uv" class="busuanzi_value_site_uv"></span> </span><span id="busuanzi_container_site_pv" class="busuanzi_container_site_pv">总访问量&nbsp;<span id="busuanzi_value_site_pv" class="busuanzi_value_site_pv"></span></span></div><div class="theme-info info-item"><span class="powered-by-container">由 <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" href="https://hexo.io">Hexo</a> 驱动</span><br><span class="theme-version-container">主题&nbsp;<a class="theme-version" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.1.2</a></span></div><div id="start_div" style="display:none">2021/12/24 18:45:00</div><div>博客已运行 <span class="odometer" id="runtime_days"></span> 天 <span class="odometer" id="runtime_hours"></span> 小时 <span class="odometer" id="runtime_minutes"></span> 分钟 <span class="odometer" id="runtime_seconds"></span> 秒</div><script async data-pjax>try{function odometer_init(){document.querySelectorAll(".odometer").forEach(e=>{new Odometer({el:e,format:"( ddd).dd",duration:200})})}odometer_init()}catch(e){}</script></div></footer></div></div><div class="post-tools"><div class="post-tools-container"><ul class="article-tools-list"><li class="right-bottom-tools page-aside-toggle"><i class="fa-regular fa-outdent"></i></li><li class="go-comment"><i class="fa-regular fa-comments"></i></li></ul></div></div><div class="right-side-tools-container"><div class="side-tools-container"><ul class="hidden-tools-list"><li class="right-bottom-tools tool-font-adjust-plus flex-center"><i class="fa-regular fa-magnifying-glass-plus"></i></li><li class="right-bottom-tools tool-font-adjust-minus flex-center"><i class="fa-regular fa-magnifying-glass-minus"></i></li><li class="right-bottom-tools tool-expand-width flex-center"><i class="fa-regular fa-expand"></i></li><li class="right-bottom-tools tool-dark-light-toggle flex-center"><i class="fa-regular fa-moon"></i></li><li class="right-bottom-tools tool-scroll-to-bottom flex-center"><i class="fa-regular fa-arrow-down"></i></li></ul><ul class="visible-tools-list"><li class="right-bottom-tools toggle-tools-list flex-center"><i class="fa-regular fa-cog fa-spin"></i></li><li class="right-bottom-tools tool-scroll-to-top flex-center"><i class="arrow-up fas fa-arrow-up"></i> <span class="percent"></span></li></ul></div></div><div class="image-viewer-container"><img src=""></div><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-input-field-pre"><i class="fa-solid fa-keyboard"></i></span><div class="search-input-container"><input autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa-solid fa-times"></i></span></div><div id="search-result"><div id="no-result"><i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i></div></div></div></div></main><script src="https://unpkg.com/hexo-theme-redefine@2.1.2/source/js/utils.js"></script><script src="https://unpkg.com/hexo-theme-redefine@2.1.2/source/js/main.js"></script><script src="https://unpkg.com/hexo-theme-redefine@2.1.2/source/js/layouts/navbarShrink.js"></script><script src="https://unpkg.com/hexo-theme-redefine@2.1.2/source/js/tools/scrollTopBottom.js"></script><script src="https://unpkg.com/hexo-theme-redefine@2.1.2/source/js/tools/lightDarkSwitch.js"></script><script src="https://unpkg.com/hexo-theme-redefine@2.1.2/source/js/tools/localSearch.js"></script><script src="https://unpkg.com/hexo-theme-redefine@2.1.2/source/js/tools/codeBlock.js"></script><script src="https://unpkg.com/hexo-theme-redefine@2.1.2/source/js/layouts/lazyload.js"></script><script src="https://unpkg.com/hexo-theme-redefine@2.1.2/source/js/tools/runtime.js"></script><script src="https://unpkg.com/hexo-theme-redefine@2.1.2/source/js/layouts/odometer.min.js"></script><link rel="stylesheet" href="https://unpkg.com/hexo-theme-redefine@2.1.2/source/assets/odometer-theme-minimal.css"><script src="https://unpkg.com/hexo-theme-redefine@2.1.2/source/js/libs/Typed.min.js"></script><script src="https://unpkg.com/hexo-theme-redefine@2.1.2/source/js/plugins/typed.js"></script><div class="post-scripts pjax"><script src="https://unpkg.com/hexo-theme-redefine@2.1.2/source/js/tools/tocToggle.js"></script><script src="https://unpkg.com/hexo-theme-redefine@2.1.2/source/js/libs/anime.min.js"></script><script src="https://unpkg.com/hexo-theme-redefine@2.1.2/source/js/layouts/toc.js"></script><script src="https://unpkg.com/hexo-theme-redefine@2.1.2/source/js/plugins/tabs.js"></script></div><script src="https://unpkg.com/hexo-theme-redefine@2.1.2/source/js/libs/pjax.min.js"></script><script>window.addEventListener("DOMContentLoaded",()=>{window.pjax=new Pjax({selectors:["head title",".page-container",".pjax"],history:!0,debug:!1,cacheBust:!1,timeout:0,analytics:!1,currentUrlFullReload:!1,scrollRestoration:!1}),document.addEventListener("pjax:send",()=>{Global.utils.pjaxProgressBarStart()}),document.addEventListener("pjax:complete",()=>{Global.utils.pjaxProgressBarEnd(),window.pjax.executeScripts(document.querySelectorAll("script[data-pjax], .pjax script")),Global.refresh()})})</script></body></html>